{"version":3,"sources":["uiMatching.js"],"names":["uiPanel","require","mvs","GLB","cc","Class","extends","properties","onLoad","_super","isRoomOwner","playerIcons","playerModel","nodeDict","active","i","MAX_PLAYER_COUNT","playerTemp","instantiate","addChild","position","v2","push","on","leaveRoom","clientEvent","eventType","joinRoomResponse","joinRoomNotify","leaveRoomResponse","leaveRoomNotify","joinOverResponse","joinRandomRoom","result","matchType","RANDOM_MATCH","engine","console","log","PROPERTY_MATCH","matchinfo","MatchInfo","maxPlayer","mode","canWatch","tags","tagsInfo","joinRoomWithProperties","startGame","director","loadScene","data","status","roomInfo","roomID","roomId","userIds","userInfo","id","playerIcon","j","roomUserInfoList","length","getComponent","setData","userId","playerUserIds","joinOver","JSON","stringify","roomUserInfo","leaveRoomInfo","playerId","init","leaveRoomRsp","uiFunc","closeUI","node","name","destroy","joinOverRsp","notifyGameStart","msg","action","GAME_START_EVENT","Game","GameManager","sendEventEx","onDestroy","off"],"mappings":";;;;;;AAAA,IAAIA,UAAUC,QAAQ,SAAR,CAAd;AACA,IAAIC,MAAMD,QAAQ,SAAR,CAAV;AACA,IAAIE,MAAMF,QAAQ,KAAR,CAAV;AACAG,GAAGC,KAAH,CAAS;AACLC,aAASN,OADJ;AAELO,gBAAY,EAFP;;AAILC,UAJK,oBAII;AACL,aAAKC,MAAL;AACAN,YAAIO,WAAJ,GAAkB,KAAlB;AACA,aAAKC,WAAL,GAAmB,EAAnB;AACA,aAAKC,WAAL,GAAmB,KAAKC,QAAL,CAAc,YAAd,CAAnB;AACA,aAAKD,WAAL,CAAiBE,MAAjB,GAA0B,KAA1B;AACA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIZ,IAAIa,gBAAxB,EAA0CD,GAA1C,EAA+C;AAC3C,gBAAIE,aAAab,GAAGc,WAAH,CAAe,KAAKN,WAApB,CAAjB;AACAK,uBAAWH,MAAX,GAAoB,IAApB;AACA,iBAAKD,QAAL,CAAc,cAAd,EAA8BM,QAA9B,CAAuCF,UAAvC;AACAA,uBAAWG,QAAX,GAAsBhB,GAAGiB,EAAH,CAAM,CAAN,EAAS,CAAT,CAAtB;AACA,iBAAKV,WAAL,CAAiBW,IAAjB,CAAsBL,UAAtB;AACH;;AAED,aAAKJ,QAAL,CAAc,MAAd,EAAsBU,EAAtB,CAAyB,OAAzB,EAAkC,KAAKC,SAAvC,EAAkD,IAAlD;;AAEAC,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBC,gBAArC,EAAuD,KAAKA,gBAA5D,EAA8E,IAA9E;AACAF,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBE,cAArC,EAAqD,KAAKA,cAA1D,EAA0E,IAA1E;AACAH,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBG,iBAArC,EAAwD,KAAKA,iBAA7D,EAAgF,IAAhF;AACAJ,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBI,eAArC,EAAsD,KAAKA,eAA3D,EAA4E,IAA5E;AACAL,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBK,gBAArC,EAAuD,KAAKA,gBAA5D,EAA8E,IAA9E;AACH,KAzBI;;;AA2BLC,oBAAgB,0BAAW;AACvB,YAAIC,SAAS,IAAb;AACA,YAAI9B,IAAI+B,SAAJ,KAAkB/B,IAAIgC,YAA1B,EAAwC;AACpCF,qBAAS/B,IAAIkC,MAAJ,CAAWJ,cAAX,CAA0B7B,IAAIa,gBAA9B,EAAgD,EAAhD,CAAT;AACA,gBAAIiB,WAAW,CAAf,EAAkB;AACdI,wBAAQC,GAAR,CAAY,gBAAgBL,MAA5B;AACH;AACJ,SALD,MAKO,IAAI9B,IAAI+B,SAAJ,KAAkB/B,IAAIoC,cAA1B,EAA0C;AAC7C,gBAAIC,YAAY,IAAItC,IAAIuC,SAAR,EAAhB;AACAD,sBAAUE,SAAV,GAAsBvC,IAAIa,gBAA1B;AACAwB,sBAAUG,IAAV,GAAiB,CAAjB;AACAH,sBAAUI,QAAV,GAAqB,CAArB;AACAJ,sBAAUK,IAAV,GAAiB1C,IAAI2C,QAArB;AACAb,qBAAS/B,IAAIkC,MAAJ,CAAWW,sBAAX,CAAkCP,SAAlC,EAA6C,wBAA7C,CAAT;AACA,gBAAIP,WAAW,CAAf,EAAkB;AACdI,wBAAQC,GAAR,CAAY,gBAAgBL,MAA5B;AACH;AACJ;AACJ,KA7CI;;AA+CLe,eAAW,qBAAW;AAClBX,gBAAQC,GAAR,CAAY,QAAZ;AACAlC,WAAG6C,QAAH,CAAYC,SAAZ,CAAsB,MAAtB;AACH,KAlDI;;AAoDLvB,sBAAkB,0BAASwB,IAAT,EAAe;AAC7B,YAAIA,KAAKC,MAAL,KAAgB,GAApB,EAAyB;AACrBf,oBAAQC,GAAR,CAAY,qBAAqBa,KAAKC,MAAtC;AACH,SAFD,MAEO;AACHf,oBAAQC,GAAR,CAAY,QAAZ;AACAD,oBAAQC,GAAR,CAAY,UAAUa,KAAKE,QAAL,CAAcC,MAApC;AACH;AACDnD,YAAIoD,MAAJ,GAAaJ,KAAKE,QAAL,CAAcC,MAA3B;AACA,YAAIE,UAAU,CAACrD,IAAIsD,QAAJ,CAAaC,EAAd,CAAd;AACArB,gBAAQC,GAAR,CAAY,WAAWkB,OAAvB;;AAEA,YAAIG,aAAa,IAAjB;AACA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIT,KAAKU,gBAAL,CAAsBC,MAA1C,EAAkDF,GAAlD,EAAuD;AACnDD,yBAAa,KAAKhD,WAAL,CAAiBiD,CAAjB,EAAoBG,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAc,CAACA,WAAWF,QAA9B,EAAwC;AACpCE,2BAAWK,OAAX,CAAmBb,KAAKU,gBAAL,CAAsBD,CAAtB,CAAnB;AACA,oBAAIzD,IAAIsD,QAAJ,CAAaC,EAAb,KAAoBP,KAAKU,gBAAL,CAAsBD,CAAtB,EAAyBK,MAAjD,EAAyD;AACrDT,4BAAQlC,IAAR,CAAa6B,KAAKU,gBAAL,CAAsBD,CAAtB,EAAyBK,MAAtC;AACH;AACJ;AACJ;;AAED,aAAK,IAAIlD,IAAI,CAAb,EAAgBA,IAAI,KAAKJ,WAAL,CAAiBmD,MAArC,EAA6C/C,GAA7C,EAAkD;AAC9C4C,yBAAa,KAAKhD,WAAL,CAAiBI,CAAjB,EAAoBgD,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAc,CAACA,WAAWF,QAA9B,EAAwC;AACpCE,2BAAWK,OAAX,CAAmB7D,IAAIsD,QAAvB;AACA;AACH;AACJ;AACDtD,YAAI+D,aAAJ,GAAoBV,OAApB;AACA,YAAIA,QAAQM,MAAR,IAAkB3D,IAAIa,gBAA1B,EAA4C;AACxC,gBAAIiB,SAAS/B,IAAIkC,MAAJ,CAAW+B,QAAX,CAAoB,EAApB,CAAb;AACA9B,oBAAQC,GAAR,CAAY,WAAZ;AACA,gBAAIL,WAAW,CAAf,EAAkB;AACdI,wBAAQC,GAAR,CAAY,aAAZ,EAA2BL,MAA3B;AACH;;AAED9B,gBAAI+D,aAAJ,GAAoBV,OAApB;AACH;AACJ,KA3FI;;AA6FL5B,oBAAgB,wBAASuB,IAAT,EAAe;AAC3Bd,gBAAQC,GAAR,CAAY,kCAAkC8B,KAAKC,SAAL,CAAelB,KAAKmB,YAApB,CAA9C;AACA,YAAIX,aAAa,IAAjB;AACA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,KAAKjD,WAAL,CAAiBmD,MAArC,EAA6CF,GAA7C,EAAkD;AAC9CD,yBAAa,KAAKhD,WAAL,CAAiBiD,CAAjB,EAAoBG,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAc,CAACA,WAAWF,QAA9B,EAAwC;AACpCE,2BAAWK,OAAX,CAAmBb,KAAKmB,YAAxB;AACA;AACH;AACJ;AACJ,KAvGI;;AAyGL9C,eAAW,qBAAW;AAClBtB,YAAIkC,MAAJ,CAAWZ,SAAX;AACH,KA3GI;;AA6GLM,qBAAiB,yBAASqB,IAAT,EAAe;AAC5B,YAAIhD,IAAIoD,MAAJ,KAAeJ,KAAKoB,aAAL,CAAmBjB,MAAtC,EAA8C;AAC1C,iBAAK,IAAIvC,IAAI,CAAb,EAAgBA,IAAI,KAAKJ,WAAL,CAAiBmD,MAArC,EAA6C/C,GAA7C,EAAkD;AAC9C,oBAAI4C,aAAa,KAAKhD,WAAL,CAAiBI,CAAjB,EAAoBgD,YAApB,CAAiC,YAAjC,CAAjB;AACA,oBAAIJ,cAAcA,WAAWF,QAAzB,IAAqCE,WAAWa,QAAX,KAAwBrB,KAAKoB,aAAL,CAAmBN,MAApF,EAA4F;AACxFN,+BAAWc,IAAX;AACA;AACH;AACJ;AACJ;AACJ,KAvHI;;AAyHL5C,uBAAmB,2BAASsB,IAAT,EAAe;AAC9B,YAAIA,KAAKuB,YAAL,CAAkBtB,MAAlB,KAA6B,GAAjC,EAAsC;AAClCf,oBAAQC,GAAR,CAAY,QAAZ;AACA,iBAAK,IAAIvB,IAAI,CAAb,EAAgBA,IAAI,KAAKJ,WAAL,CAAiBmD,MAArC,EAA6C/C,GAA7C,EAAkD;AAC9C,oBAAI4C,aAAa,KAAKhD,WAAL,CAAiBI,CAAjB,EAAoBgD,YAApB,CAAiC,YAAjC,CAAjB;AACA,oBAAIJ,UAAJ,EAAgB;AACZA,+BAAWc,IAAX;AACA;AACH;AACJ;AACDE,mBAAOC,OAAP,CAAe,KAAKC,IAAL,CAAUC,IAAzB;AACA,iBAAKD,IAAL,CAAUE,OAAV;AACH,SAXD,MAWO;AACH1C,oBAAQC,GAAR,CAAY,QAAZ;AACH;AACJ,KAxII;;AA2ILP,sBAAkB,0BAASoB,IAAT,EAAe;AAC7B,YAAIA,KAAK6B,WAAL,CAAiB5B,MAAjB,KAA4B,GAAhC,EAAqC;AACjCf,oBAAQC,GAAR,CAAY,QAAZ;AACA,iBAAK2C,eAAL;AACH,SAHD,MAGO;AACH5C,oBAAQC,GAAR,CAAY,iBAAZ,EAA+Ba,KAAK6B,WAAL,CAAiB5B,MAAhD;AACH;AACJ,KAlJI;;AAoJL6B,qBAAiB,2BAAW;AACxB9E,YAAIO,WAAJ,GAAkB,IAAlB;AACA,YAAIwE,MAAM;AACNC,oBAAQhF,IAAIiF,gBADN;AAEN5B,qBAASrD,IAAI+D;AAFP,SAAV;AAIAmB,aAAKC,WAAL,CAAiBC,WAAjB,CAA6BL,GAA7B;AACH,KA3JI;;AA6JLM,eAAW,qBAAW;AAClB/D,oBAAYgE,GAAZ,CAAgBhE,YAAYC,SAAZ,CAAsBC,gBAAtC,EAAwD,KAAKA,gBAA7D,EAA+E,IAA/E;AACAF,oBAAYgE,GAAZ,CAAgBhE,YAAYC,SAAZ,CAAsBE,cAAtC,EAAsD,KAAKA,cAA3D,EAA2E,IAA3E;AACAH,oBAAYgE,GAAZ,CAAgBhE,YAAYC,SAAZ,CAAsBG,iBAAtC,EAAyD,KAAKA,iBAA9D,EAAiF,IAAjF;AACAJ,oBAAYgE,GAAZ,CAAgBhE,YAAYC,SAAZ,CAAsBI,eAAtC,EAAuD,KAAKA,eAA5D,EAA6E,IAA7E;AACAL,oBAAYgE,GAAZ,CAAgBhE,YAAYC,SAAZ,CAAsBK,gBAAtC,EAAwD,KAAKA,gBAA7D,EAA+E,IAA/E;AAEH;AApKI,CAAT","file":"uiMatching.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\common\\script","sourcesContent":["var uiPanel = require(\"uiPanel\");\r\nvar mvs = require(\"Matchvs\");\r\nvar GLB = require(\"Glb\");\r\ncc.Class({\r\n    extends: uiPanel,\r\n    properties: {},\r\n\r\n    onLoad() {\r\n        this._super();\r\n        GLB.isRoomOwner = false;\r\n        this.playerIcons = [];\r\n        this.playerModel = this.nodeDict[\"playerIcon\"];\r\n        this.playerModel.active = false;\r\n        for (var i = 0; i < GLB.MAX_PLAYER_COUNT; i++) {\r\n            var playerTemp = cc.instantiate(this.playerModel);\r\n            playerTemp.active = true;\r\n            this.nodeDict[\"playerLayout\"].addChild(playerTemp);\r\n            playerTemp.position = cc.v2(0, 0);\r\n            this.playerIcons.push(playerTemp);\r\n        }\r\n\r\n        this.nodeDict[\"quit\"].on(\"click\", this.leaveRoom, this);\r\n\r\n        clientEvent.on(clientEvent.eventType.joinRoomResponse, this.joinRoomResponse, this);\r\n        clientEvent.on(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\r\n        clientEvent.on(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\r\n        clientEvent.on(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\r\n        clientEvent.on(clientEvent.eventType.joinOverResponse, this.joinOverResponse, this);\r\n    },\r\n\r\n    joinRandomRoom: function() {\r\n        var result = null;\r\n        if (GLB.matchType === GLB.RANDOM_MATCH) {\r\n            result = mvs.engine.joinRandomRoom(GLB.MAX_PLAYER_COUNT, '');\r\n            if (result !== 0) {\r\n                console.log('进入房间失败,错误码:' + result);\r\n            }\r\n        } else if (GLB.matchType === GLB.PROPERTY_MATCH) {\r\n            var matchinfo = new mvs.MatchInfo();\r\n            matchinfo.maxPlayer = GLB.MAX_PLAYER_COUNT;\r\n            matchinfo.mode = 0;\r\n            matchinfo.canWatch = 0;\r\n            matchinfo.tags = GLB.tagsInfo;\r\n            result = mvs.engine.joinRoomWithProperties(matchinfo, \"joinRoomWithProperties\");\r\n            if (result !== 0) {\r\n                console.log('进入房间失败,错误码:' + result);\r\n            }\r\n        }\r\n    },\r\n\r\n    startGame: function() {\r\n        console.log('游戏即将开始');\r\n        cc.director.loadScene('game');\r\n    },\r\n\r\n    joinRoomResponse: function(data) {\r\n        if (data.status !== 200) {\r\n            console.log('进入房间失败,异步回调错误码: ' + data.status);\r\n        } else {\r\n            console.log('进入房间成功');\r\n            console.log('房间号: ' + data.roomInfo.roomID);\r\n        }\r\n        GLB.roomId = data.roomInfo.roomID;\r\n        var userIds = [GLB.userInfo.id]\r\n        console.log('房间用户: ' + userIds);\r\n\r\n        var playerIcon = null;\r\n        for (var j = 0; j < data.roomUserInfoList.length; j++) {\r\n            playerIcon = this.playerIcons[j].getComponent('playerIcon');\r\n            if (playerIcon && !playerIcon.userInfo) {\r\n                playerIcon.setData(data.roomUserInfoList[j]);\r\n                if (GLB.userInfo.id !== data.roomUserInfoList[j].userId) {\r\n                    userIds.push(data.roomUserInfoList[j].userId);\r\n                }\r\n            }\r\n        }\r\n\r\n        for (var i = 0; i < this.playerIcons.length; i++) {\r\n            playerIcon = this.playerIcons[i].getComponent('playerIcon');\r\n            if (playerIcon && !playerIcon.userInfo) {\r\n                playerIcon.setData(GLB.userInfo);\r\n                break;\r\n            }\r\n        }\r\n        GLB.playerUserIds = userIds;\r\n        if (userIds.length >= GLB.MAX_PLAYER_COUNT) {\r\n            var result = mvs.engine.joinOver(\"\");\r\n            console.log(\"发出关闭房间的通知\");\r\n            if (result !== 0) {\r\n                console.log(\"关闭房间失败，错误码：\", result);\r\n            }\r\n\r\n            GLB.playerUserIds = userIds;\r\n        }\r\n    },\r\n\r\n    joinRoomNotify: function(data) {\r\n        console.log(\"joinRoomNotify, roomUserInfo:\" + JSON.stringify(data.roomUserInfo));\r\n        var playerIcon = null;\r\n        for (var j = 0; j < this.playerIcons.length; j++) {\r\n            playerIcon = this.playerIcons[j].getComponent('playerIcon');\r\n            if (playerIcon && !playerIcon.userInfo) {\r\n                playerIcon.setData(data.roomUserInfo);\r\n                break;\r\n            }\r\n        }\r\n    },\r\n\r\n    leaveRoom: function() {\r\n        mvs.engine.leaveRoom();\r\n    },\r\n\r\n    leaveRoomNotify: function(data) {\r\n        if (GLB.roomId === data.leaveRoomInfo.roomID) {\r\n            for (var i = 0; i < this.playerIcons.length; i++) {\r\n                var playerIcon = this.playerIcons[i].getComponent('playerIcon');\r\n                if (playerIcon && playerIcon.userInfo && playerIcon.playerId === data.leaveRoomInfo.userId) {\r\n                    playerIcon.init();\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    },\r\n\r\n    leaveRoomResponse: function(data) {\r\n        if (data.leaveRoomRsp.status === 200) {\r\n            console.log(\"离开房间成功\");\r\n            for (var i = 0; i < this.playerIcons.length; i++) {\r\n                var playerIcon = this.playerIcons[i].getComponent('playerIcon');\r\n                if (playerIcon) {\r\n                    playerIcon.init();\r\n                    break;\r\n                }\r\n            }\r\n            uiFunc.closeUI(this.node.name);\r\n            this.node.destroy();\r\n        } else {\r\n            console.log(\"离开房间失败\");\r\n        }\r\n    },\r\n\r\n\r\n    joinOverResponse: function(data) {\r\n        if (data.joinOverRsp.status === 200) {\r\n            console.log(\"关闭房间成功\");\r\n            this.notifyGameStart();\r\n        } else {\r\n            console.log(\"关闭房间失败，回调通知错误码：\", data.joinOverRsp.status);\r\n        }\r\n    },\r\n\r\n    notifyGameStart: function() {\r\n        GLB.isRoomOwner = true;\r\n        var msg = {\r\n            action: GLB.GAME_START_EVENT,\r\n            userIds: GLB.playerUserIds\r\n        };\r\n        Game.GameManager.sendEventEx(msg);\r\n    },\r\n\r\n    onDestroy: function() {\r\n        clientEvent.off(clientEvent.eventType.joinRoomResponse, this.joinRoomResponse, this);\r\n        clientEvent.off(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\r\n        clientEvent.off(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\r\n        clientEvent.off(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\r\n        clientEvent.off(clientEvent.eventType.joinOverResponse, this.joinOverResponse, this);\r\n\r\n    }\r\n});\r\n"]}