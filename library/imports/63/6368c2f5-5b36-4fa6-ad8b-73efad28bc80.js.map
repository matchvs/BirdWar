{"version":3,"sources":["../../../../../assets/game/script/assets/game/script/bullet.js"],"names":["mvs","require","GLB","cc","Class","extends","Component","properties","speed","init","hostPlayer","index","total","bulletPointY","bulletId","offset","node","parent","worldPos","firePoint","convertToWorldSpaceAR","v2","bulletPoint","convertToNodeSpaceAR","position","x","rotation","speedY","players","Game","PlayerManager","onCollisionEnter","other","group","game","groupList","groupIndex","bullet","getComponent","camp","BulletManager","recycleBullet","player","isDied","isRoomOwner","hurt","userId","item","getItem","itemType","playGetClip","active","destroy","update","dt","isTrack","targetPlayer","playerScript","minDistance","Number","MAX_VALUE","i","length","selfPos","targetPos","distance","sub","mag","pos","Camp","Enemy","y","rad","signAngle","angle","Math","PI","lerp","abs","a","b","r"],"mappings":";;;;;;AAAA,IAAIA,MAAMC,QAAQ,SAAR,CAAV;AACA,IAAIC,MAAMD,QAAQ,KAAR,CAAV;AACAE,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACRC,eAAO;AADC,KAHP;;AAOLC,UAAM,cAASC,UAAT,EAAqBC,KAArB,EAA4BC,KAA5B,EAAmCC,YAAnC,EAAiDC,QAAjD,EAA2D;AAC7D,aAAKA,QAAL,GAAgBA,QAAhB;AACA,YAAIC,SAAS,CAACJ,QAAS,CAACC,QAAQ,CAAT,IAAc,CAAxB,IAA8B,EAA3C;AACA,aAAKF,UAAL,GAAkBA,UAAlB;AACA,aAAKM,IAAL,CAAUC,MAAV,GAAmBP,WAAWM,IAAX,CAAgBC,MAAnC;AACA,YAAIC,WAAWR,WAAWS,SAAX,CAAqBC,qBAArB,CAA2CjB,GAAGkB,EAAH,CAAM,CAAN,EAAS,CAAT,CAA3C,CAAf;AACA,YAAIC,cAAcZ,WAAWM,IAAX,CAAgBC,MAAhB,CAAuBM,oBAAvB,CAA4CL,QAA5C,CAAlB;AACA,aAAKF,IAAL,CAAUQ,QAAV,GAAqBrB,GAAGkB,EAAH,CAAMC,YAAYG,CAAlB,EAAqBZ,eAAeE,MAApC,CAArB;AACA,aAAKC,IAAL,CAAUU,QAAV,GAAqB,CAArB;AACA,aAAKC,MAAL,GAAc,CAAd;AACA,aAAKC,OAAL,GAAeC,KAAKC,aAAL,CAAmBF,OAAlC;AACH,KAlBI;;AAoBLG,sBAAkB,0BAASC,KAAT,EAAgB;AAC9B,YAAIC,QAAQ9B,GAAG+B,IAAH,CAAQC,SAAR,CAAkBH,MAAMhB,IAAN,CAAWoB,UAA7B,CAAZ;AACA,YAAIH,UAAU,QAAd,EAAwB;AACpB,gBAAII,SAASL,MAAMhB,IAAN,CAAWsB,YAAX,CAAwB,QAAxB,CAAb;AACA,gBAAID,UAAUA,OAAO3B,UAAP,CAAkB6B,IAAlB,KAA2B,KAAK7B,UAAL,CAAgB6B,IAAzD,EAA+D;AAC3DV,qBAAKW,aAAL,CAAmBC,aAAnB,CAAiC,IAAjC;AACH;AACJ,SALD,MAKO,IAAIR,UAAU,QAAd,EAAwB;AAC3B,gBAAIS,SAASV,MAAMhB,IAAN,CAAWsB,YAAX,CAAwB,QAAxB,CAAb;AACA,gBAAII,UAAU,CAACA,OAAOC,MAAlB,IAA4BD,OAAOH,IAAP,KAAgB,KAAK7B,UAAL,CAAgB6B,IAAhE,EAAsE;AAClEV,qBAAKW,aAAL,CAAmBC,aAAnB,CAAiC,IAAjC;AACA,oBAAIvC,IAAI0C,WAAR,EAAqB;AACjBF,2BAAOG,IAAP,CAAY,KAAKnC,UAAL,CAAgBoC,MAA5B;AACH;AACJ;AACJ,SARM,MAQA,IAAIb,UAAU,MAAd,EAAsB;AACzBJ,iBAAKW,aAAL,CAAmBC,aAAnB,CAAiC,IAAjC;AACA,gBAAIM,OAAOf,MAAMhB,IAAN,CAAWsB,YAAX,CAAwB,MAAxB,CAAX;AACA,gBAAIS,IAAJ,EAAU;AACN,oBAAI7C,IAAI0C,WAAR,EAAqB;AACjB,yBAAKlC,UAAL,CAAgBsC,OAAhB,CAAwBD,KAAKE,QAA7B;AACH;AACDF,qBAAKG,WAAL;AACH;AACDlB,kBAAMhB,IAAN,CAAWmC,MAAX,GAAoB,KAApB;AACAnB,kBAAMhB,IAAN,CAAWoC,OAAX;AACH;AACJ,KA/CI;;AAiDLC,UAjDK,kBAiDEC,EAjDF,EAiDM;AACP,YAAI,KAAK5C,UAAL,CAAgB6C,OAAhB,IAA2B,KAAK3B,OAApC,EAA6C;AACzC,gBAAI4B,eAAe,IAAnB;AACA,gBAAIC,eAAe,IAAnB;AACA,gBAAIC,cAAcC,OAAOC,SAAzB;AACA,iBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,KAAKjC,OAAL,CAAakC,MAAjC,EAAyCD,GAAzC,EAA8C;AAC1CJ,+BAAe,KAAK7B,OAAL,CAAaiC,CAAb,EAAgBvB,YAAhB,CAA6B,QAA7B,CAAf;AACA,oBAAImB,gBAAgBA,aAAalB,IAAb,KAAsB,KAAK7B,UAAL,CAAgB6B,IAA1D,EAAgE;AAC5D,wBAAIwB,UAAU,KAAK/C,IAAL,CAAUI,qBAAV,CAAgCjB,GAAGkB,EAAH,CAAM,CAAN,EAAS,CAAT,CAAhC,CAAd;AACA,wBAAI2C,YAAYP,aAAazC,IAAb,CAAkBI,qBAAlB,CAAwCjB,GAAGkB,EAAH,CAAM,CAAN,EAAS,CAAT,CAAxC,CAAhB;AACA;AACA;AACA,wBAAI4C,WAAWF,QAAQG,GAAR,CAAYF,SAAZ,EAAuBG,GAAvB,EAAf;AACA,wBAAIF,WAAWP,WAAf,EAA4B;AACxBF,uCAAe,KAAK5B,OAAL,CAAaiC,CAAb,CAAf;AACH;AACJ;AACJ;AACD,gBAAIL,YAAJ,EAAkB;AACd;AACAC,+BAAeD,aAAalB,YAAb,CAA0B,QAA1B,CAAf;AACA,oBAAI8B,GAAJ;AACA,oBAAIX,aAAalB,IAAb,KAAsB8B,KAAKC,KAA/B,EAAsC;AAClCF,0BAAMjE,GAAGkB,EAAH,CAAM,KAAKL,IAAL,CAAUS,CAAV,GAAc+B,aAAa/B,CAAjC,EAAoC,KAAKT,IAAL,CAAUuD,CAAV,GAAcf,aAAae,CAA/D,CAAN;AACH,iBAFD,MAEO;AACHH,0BAAMjE,GAAGkB,EAAH,CAAMmC,aAAa/B,CAAb,GAAiB,KAAKT,IAAL,CAAUS,CAAjC,EAAoC+B,aAAae,CAAb,GAAiB,KAAKvD,IAAL,CAAUuD,CAA/D,CAAN;AACH;AACD;AACA;AACA,oBAAIC,MAAMJ,IAAIK,SAAJ,CAActE,GAAGkB,EAAH,CAAM,CAAC,CAAP,EAAU,CAAV,CAAd,CAAV;AACA,oBAAIqD,QAAS,MAAMC,KAAKC,EAAZ,GAAkBJ,GAA9B;;AAEA,oBAAIE,QAAQ,EAAZ,EAAgB;AACZA,4BAAQ,EAAR;AACH;AACD,oBAAIA,QAAQ,CAAC,EAAb,EAAiB;AACbA,4BAAQ,CAAC,EAAT;AACH;;AAED,oBAAIhD,WAAW,KAAKmD,IAAL,CAAU,KAAK7D,IAAL,CAAUU,QAApB,EAA8BgD,KAA9B,EAAqCpB,EAArC,CAAf;AACA,qBAAKtC,IAAL,CAAUU,QAAV,GAAqBA,QAArB;;AAEA,oBAAIiD,KAAKG,GAAL,CAAS,KAAK9D,IAAL,CAAUuD,CAAV,GAAcf,aAAae,CAApC,IAAyC,CAA7C,EAAgD;AAC5C,wBAAI,KAAKvD,IAAL,CAAUuD,CAAV,GAAcf,aAAae,CAA/B,EAAkC;AAC9B,6BAAK5C,MAAL,IAAegD,KAAKG,GAAL,CAAS,KAAKtE,KAAL,GAAa8C,EAAtB,CAAf;AACH,qBAFD,MAEO;AACH,6BAAK3B,MAAL,IAAegD,KAAKG,GAAL,CAAS,KAAKtE,KAAL,GAAa8C,EAAtB,CAAf;AACH;AACD;AACA;AACA,yBAAKtC,IAAL,CAAUuD,CAAV,GAAc,KAAKvD,IAAL,CAAUQ,QAAV,CAAmB+C,CAAnB,GAAwB,KAAK5C,MAAL,GAAc2B,EAApD;AACH;AACD;AACA;AACA,qBAAKtC,IAAL,CAAUS,CAAV,GAAc,KAAKT,IAAL,CAAUQ,QAAV,CAAmBC,CAAnB,GAAwB,KAAKjB,KAAL,GAAa8C,EAAnD;AACH,aArCD,MAqCO;AACH;AACA;AACA,qBAAKtC,IAAL,CAAUS,CAAV,GAAc,KAAKT,IAAL,CAAUQ,QAAV,CAAmBC,CAAnB,GAAwB,KAAKjB,KAAL,GAAa8C,EAAnD;AACH;AACJ,SA3DD,MA2DO;AACH;AACA;AACA,iBAAKtC,IAAL,CAAUS,CAAV,GAAc,KAAKT,IAAL,CAAUQ,QAAV,CAAmBC,CAAnB,GAAwB,KAAKjB,KAAL,GAAa8C,EAAnD;AACH;AACD,YAAIqB,KAAKG,GAAL,CAAS,KAAK9D,IAAL,CAAUQ,QAAV,CAAmBC,CAA5B,IAAiC,GAArC,EAA0C;AACtCI,iBAAKW,aAAL,CAAmBC,aAAnB,CAAiC,IAAjC;AACH;AACJ,KArHI;AAuHLoC,QAvHK,gBAuHAE,CAvHA,EAuHGC,CAvHH,EAuHMC,CAvHN,EAuHS;AACV,eAAOF,IAAI,CAACC,IAAID,CAAL,IAAUE,CAArB;AACH;AAzHI,CAAT","file":"bullet.js","sourceRoot":"../../../../../assets/game/script","sourcesContent":["var mvs = require(\"Matchvs\");\nvar GLB = require(\"Glb\");\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        speed: 0\n    },\n\n    init: function(hostPlayer, index, total, bulletPointY, bulletId) {\n        this.bulletId = bulletId\n        var offset = (index - ((total + 1) / 2)) * 40;\n        this.hostPlayer = hostPlayer;\n        this.node.parent = hostPlayer.node.parent;\n        var worldPos = hostPlayer.firePoint.convertToWorldSpaceAR(cc.v2(0, 0));\n        var bulletPoint = hostPlayer.node.parent.convertToNodeSpaceAR(worldPos);\n        this.node.position = cc.v2(bulletPoint.x, bulletPointY + offset);\n        this.node.rotation = 0;\n        this.speedY = 0;\n        this.players = Game.PlayerManager.players;\n    },\n\n    onCollisionEnter: function(other) {\n        var group = cc.game.groupList[other.node.groupIndex];\n        if (group === 'bullet') {\n            var bullet = other.node.getComponent('bullet');\n            if (bullet && bullet.hostPlayer.camp !== this.hostPlayer.camp) {\n                Game.BulletManager.recycleBullet(this);\n            }\n        } else if (group === 'player') {\n            var player = other.node.getComponent('player');\n            if (player && !player.isDied && player.camp !== this.hostPlayer.camp) {\n                Game.BulletManager.recycleBullet(this);\n                if (GLB.isRoomOwner) {\n                    player.hurt(this.hostPlayer.userId);\n                }\n            }\n        } else if (group === 'item') {\n            Game.BulletManager.recycleBullet(this);\n            var item = other.node.getComponent('item');\n            if (item) {\n                if (GLB.isRoomOwner) {\n                    this.hostPlayer.getItem(item.itemType);\n                }\n                item.playGetClip();\n            }\n            other.node.active = false;\n            other.node.destroy();\n        }\n    },\n\n    update(dt) {\n        if (this.hostPlayer.isTrack && this.players) {\n            var targetPlayer = null;\n            var playerScript = null;\n            var minDistance = Number.MAX_VALUE;\n            for (var i = 0; i < this.players.length; i++) {\n                playerScript = this.players[i].getComponent('player');\n                if (playerScript && playerScript.camp !== this.hostPlayer.camp) {\n                    var selfPos = this.node.convertToWorldSpaceAR(cc.v2(0, 0));\n                    var targetPos = playerScript.node.convertToWorldSpaceAR(cc.v2(0, 0));\n                    //修改\n                    //var distance = cc.pDistance(selfPos, targetPos);\n                    var distance = selfPos.sub(targetPos).mag();\n                    if (distance < minDistance) {\n                        targetPlayer = this.players[i];\n                    }\n                }\n            }\n            if (targetPlayer) {\n                // 跟踪目标--\n                playerScript = targetPlayer.getComponent('player');\n                var pos;\n                if (playerScript.camp === Camp.Enemy) {\n                    pos = cc.v2(this.node.x - targetPlayer.x, this.node.y - targetPlayer.y);\n                } else {\n                    pos = cc.v2(targetPlayer.x - this.node.x, targetPlayer.y - this.node.y);\n                }\n                //修改\n                //var rad = cc.pAngleSigned(pos, cc.v2(-1, 0));\n                var rad = pos.signAngle(cc.v2(-1, 0));\n                var angle = (180 / Math.PI) * rad;\n\n                if (angle > 60) {\n                    angle = 60;\n                }\n                if (angle < -60) {\n                    angle = -60;\n                }\n\n                var rotation = this.lerp(this.node.rotation, angle, dt);\n                this.node.rotation = rotation;\n\n                if (Math.abs(this.node.y - targetPlayer.y) > 1) {\n                    if (this.node.y > targetPlayer.y) {\n                        this.speedY -= Math.abs(this.speed * dt);\n                    } else {\n                        this.speedY += Math.abs(this.speed * dt);\n                    }\n                    //修改\n                    //this.node.setPositionY(this.node.position.y + (this.speedY * dt));\n                    this.node.y = this.node.position.y + (this.speedY * dt);\n                }\n                //修改\n                //this.node.setPositionX(this.node.position.x + (this.speed * dt));\n                this.node.x = this.node.position.x + (this.speed * dt);\n            } else {\n                //修改\n                //this.node.setPositionX(this.node.position.x + (this.speed * dt));\n                this.node.x = this.node.position.x + (this.speed * dt);\n            }\n        } else {\n            //修改\n            //this.node.setPositionX(this.node.position.x + (this.speed * dt));\n            this.node.x = this.node.position.x + (this.speed * dt);\n        }\n        if (Math.abs(this.node.position.x) > 360) {\n            Game.BulletManager.recycleBullet(this);\n        }\n    },\n\n    lerp(a, b, r) {\n        return a + (b - a) * r;\n    },\n})\n;\n"]}